/**
 * search jQuery Plug-in
 *
 * Copyright (c) 2011, Nikolay Martynenko
 *
 * Licensed under The MIT License which can be obtained from <http://www.opensource.org>
 *
 * search is a jQuery Plug-in enables easy search and highlight/replace manipulation over the DOM text nodes.
 *
 * It uses jQuery textSelect plugin for highlighting of search result(otherwise it highlights whole element).
 * http://opensource.csimon.info/#page=textSelect
 *
 * It uses jQuery scrollTo plugin for smooth scrolling to selected element.
 * http://flesler.blogspot.com/2007/10/jqueryscrollto.html
 */
(function(d){d.expr[":"].containsi=function(a,b,c){return jQuery(a).text().toUpperCase().indexOf(c[3].toUpperCase())>=0};d.extend(d,{search:function(a,b){typeof a==="string"||a.tagName?a=d(a):a.jquery||(a=!1);if(!a||!a.length)b&&b.debug&&window.console&&console.warn("nothing selected, can't search, returning nothing");else{var c=d.data(a,"searcher");c||(c=new d.searcher(b,a),d.data(a,"searcher",c));c.settings.createOnly===!1&&c.nextConcurrence();return c}}});d.extend(d.fn,{search:function(a){return d.search(this, a)}});d.searcher=function(a,b){this.settings=d.extend(!0,{},d.searcher.defaults,a);this.currentContainer=b;this.currentPosition=this.settings.position;this.settings.onCreate.apply(this)};d.extend(d.searcher,{defaults:{debug:!1,createOnly:!0,caseSensitive:!1,searchSelector:"",position:-1,searchOrder:"down",searchType:"highlight",text:null,replaceBy:"",scrollTo:!1,onCreate:function(){},beforeSearch:function(){},afterSearch:function(){}},prototype:{reset:function(){this.currentPosition=-1},getText:function(){return this.settings.text}, setText:function(a){this.settings.text=a;this.reset()},getPosition:function(){return this.settings.position},setPosition:function(a){a>=this.getConcurrencesNumber()&&(a=-1);this.settings.position=a},getSearchOrder:function(){return this.settings.searchOrder==="up"||this.settings.searchOrder===!0?"up":"down"},setSearchOrder:function(a){this.settings.position=a==="up"?"up":"down"},getSearchType:function(){return this.settings.searchType},setSearchType:function(a){this.settings.searchType=a==="replace"? "replace":a==="highlightSelected"?"highlightSelected":"highlight"},getConcurrencesNumber:function(){if(this.settings.text)return this._filter(this._escape(this.settings.text)).length;else this._debug("Empty string so nothing found")},nextConcurrence:function(a){var b=this.getConcurrencesNumber();if(b==0)this._debug("Nothing has been found");else{var c=this.currentPosition,a=this._getProperty("searchOrder",a);b!=1&&(c=a===!0||a==="up"?c<=0?b-1:c-1:c==b-1?0:c+1);this.findConcurrence(c,this.settings.searchType)}}, findConcurrence:function(a,b){this.settings.beforeSearch.apply(this);if(this.settings.text){var a=this._getProperty("startPosition",a),b=this._getProperty("searchType",b),c=this._filter(this._escape(this.settings.text)).eq(a);b==="replace"?this._replace(c):b==="highlightSelected"&&d.fn.textSelect?this._highlightSelected(c):this._highlightAll(c);this.currentPosition=a;this.settings.scrollTo&&d.fn.scrollTo&&this.currentContainer.scrollTo(c.parent());this.settings.afterSearch.apply(this,d.makeArray(c))}else this._debug("Text shouldn't be empty")}, _filter:function(a){var b=this.settings.caseSensitive?"contains":"containsi";return(this.settings.searchSelector?this.currentContainer.find(this.settings.searchSelector):this.currentContainer).contents(":"+b+"('"+a+"')")},_highlightSelected:function(a){var b=a.text(),c=this.settings.text;this.settings.caseSensitive||(b=b.toUpperCase(),c=c.toUpperCase());b=b.indexOf(c);c=b+c.length;d.textSelect("setRange",{start:b,startElement:a.parent(),end:c,endElement:a.parent()})},_highlightAll:function(a){d.fn.textSelect? a.parent().textSelect("select"):this._highlightAllInternal(a)},_highlightAllInternal:function(a){a=a.parent()[0];if(d.browser.msie){var b=document.body.createTextRange();b.moveToElementText(a);b.select()}else if(d.browser.mozilla||d.browser.opera){var c=window.getSelection(),b=document.createRange();b.selectNodeContents(a);c.removeAllRanges();c.addRange(b)}else d.browser.safari&&(c=window.getSelection(),c.setBaseAndExtent(a,0,a,1))},_replace:function(a){var b=a.text().replace(this.settings.text,this.settings.replaceBy); a.parent().text(b)},_getProperty:function(a,b){return b==null||typeof b==="undefined"?this.settings[a]:b},_escape:function(a){return a.replace(/([#;&,\.\+\*\~':"\!\^$\[\]\(\)=>\|])/g,"\\$1")},_debug:function(a){this.settings.debug&&window.console&&console.debug(a)}}})})(jQuery);
